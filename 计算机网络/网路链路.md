- [一次请求全过程](#一次请求全过程)
  - [NAT转换 - 请求/响应达到局域网，确定是给局域网的用户A而非用户B](#nat转换---请求响应达到局域网确定是给局域网的用户a而非用户b)
  - [ARP - 根据IP确定MAC地址](#arp---根据ip确定mac地址)
    - [同一个网络下](#同一个网络下)
    - [不再同一网络下](#不再同一网络下)

# 一次请求全过程

URL解析--> DNS查询-->TCP连接-->处理请求-->接受响应-->渲染页面

![](https://secure2.wostatic.cn/static/tmp5MXwaJJD8btUNbfpAFe/image.png?auth_key=1706331606-cH5edn6GdaDtKoxC9mN9Jd-0-c1923c186d75574522163ee81c3e5cbc)

1. URL解析：浏览器对网址进行格式化检查，确认是有效网址，如果没有给定什么协议，会默认是http协议。协议 + 服务器 + 文件路径名
2. DNS查询：根据DNS查询IP地址的过程【浏览器缓存，操作系统缓存，路由器缓存，本地域名服务器缓存，根域名】一级一级向上问路
3. 协议栈：通过 DNS 获取到 IP地址 后，就可以把 HTTP 的传输工作交给操作系统中的协议栈。
4. 建立TCP连接：三次握手
5. 加上IP首部：TCP 模块在执行连接、收发、断开等各阶段操作时，都需要委托 IP 模块将数据封装成网络包发送给通信对象。
6. 加上MAC头部：生成了 IP 头部之后，接下来网络包还需要在 IP 头部的前面加上 MAC 头部。
7. 网卡出口：IP 生成的网络包只是存放在内存中的一串二进制数字信息，没有办法直接发送给对方。因此，我们需要将数字信息转换为电信号，才能在网线上传输，也就是说，这才是真正的数据发送过程。
8. 将包通过交换机传输：交换机根据 MAC 地址表查找 MAC 地址，然后将信号发送到相应的端口。
9. 通过路由器传输：网络包经过交换机之后，现在到达了路由器，并在此被转发到下一个路由器或目标设备。
10. 数据报抵达服务器后，要拆解数据包
11. 服务器响应请求：解析请求，生成响应头和具体响应内容，2开头的是正常。3开头表示重定向，4开头是客户端错误，5开头表示服务器错误
12. 浏览器解析：根据不同的响应状态码来做不同的事情
13. 浏览器渲染页面：浏览器显示HTML，浏览器向服务器发送请求获取嵌入在HTML中的对象，浏览器发送异步请求
14. 关闭TCP连接：根据连接属性判断是否断开连接。四次挥手。

![](https://secure2.wostatic.cn/static/PHfZWWcYMZHkDgjgktfBA/image.png?auth_key=1706331606-4BrbFx9KnggrKJEsBRNsu5-0-f5bc8b74d3451d903d9dd074db5eaf3e)

- 物理地址Mac决定了下一站的位置，IP地址决定了最后的接收方是谁, 从发送方传输到接收方，中间需要经过很多次的中转站，这些中转站需要使用Mac地址进行标记。
- MAC地址随着每一跳不断变化，IP地址（起始公网IP）则不变（保存在数据包中）
- TCP有源端口号和目的端口号，来确认是给哪个应用的；
- 其实我们服务确定IP地址，都是确定发送方的公网IP（WAN广域网），比如光猫的IP（即运营商分配的公网IP），不会是用户ip的（这是LAN局域网）
- 猫和路由器：光猫（运营商分配的公网ip—>内网ip192.168.1.1）--路由器（192.168.2.1，分配192.168.2.100-192.168.2.199给用户）
- NAT 决定给局域网的用户A而非用户B

## NAT转换 - 请求/响应达到局域网，确定是给局域网的用户A而非用户B

私有网对外访问或接受请求时，将IP包中的源IP或者目标IP转化成公有IP

- 如果单纯靠IP转换，用户A和用户B同时发送了，那server就返回的时候就不知道给谁了
- 如下图：192.168.1.2访问NAT转换时加上4096端口，192.168.1.3访问NAT转换时加上4097端口，以作区分；

![](https://secure2.wostatic.cn/static/o75REE7biKALaxbXLH4knA/image.png?auth_key=1706334354-7dEUezxDyozj93fnYA9Byn-0-949f52265d32c5004e17698f64204b6c)

## ARP - 根据IP确定MAC地址

### 同一个网络下

源IP和源MAC不变，ARP根据目标IP去广播询问目标MAC地址，由于在一个网络下，可以直接把目标MAC告诉ARP

### 不再同一网络下

A -- 网关1 -- 网关2 -- B

主机A给主机B发送数据，发现是不同网段的数据通信，而我本地是没有这个关于B的ARP映射关系的，就会发送一个arp请求报文，解析网关MAC地址

路径：

源IP和源MAC是A的，目的IP是B的，目的MAC是网关1的，由此到达网关1；  
源IP是A的，源MAC是网关1的， 目的IP是B的，目的MAC是网关2的，由此到达网关2；  
源IP是A的，源MAC是网关2的，目的IP是B的，目的MAC是B的，到达B；  
源IP是B的和MAC是B的，目的IP是A，目的MAC是网关2，到达网关2；  
源IP是B的，源MAC是网关2的，目的IP是A，目的MAC是网关1的，到达网关1；  
源IP是B的，源MAC是网关1的，目的IP是A，目的MAC是A，到达A

