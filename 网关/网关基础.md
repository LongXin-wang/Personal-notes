- [网关架构](#网关架构)
  - [网关作用](#网关作用)
- [流量控制](#流量控制)
  - [熔断](#熔断)
    - [熔断的粒度控制](#熔断的粒度控制)
    - [错误类型](#错误类型)
  - [限流](#限流)
    - [限流规则](#限流规则)
    - [限流算法](#限流算法)
      - [固定窗口和滑动窗口](#固定窗口和滑动窗口)
      - [漏桶和令牌桶](#漏桶和令牌桶)
    - [单节点限流](#单节点限流)
    - [分布式限流](#分布式限流)
  - [降级](#降级)

# 网关架构 

> https://tech.meituan.com/2021/05/20/shepherd-api-gateway.html

![](https://gitee.com/wanglongxin666/pictures/raw/master/img/202402191906860.png)

![](https://gitee.com/wanglongxin666/pictures/raw/master/img/202402191907052.png)

## 网关作用

- 请求路由
在我们的系统中由于同一个接口新老两套系统都在使用，我们需要根据请求上下文将请求路由到对应的接口。

- 统一鉴权
对于鉴权操作不涉及到业务逻辑，那么可以在网关层进行处理，不用下层到业务逻辑。

- 统一监控
由于网关是外部服务的入口，所以我们可以在这里监控我们想要的数据，比如入参出参，链路时间。

- 流量控制，熔断降级限流
对于流量控制，熔断降级限流非业务逻辑可以统一放到网关层。


# 流量控制

## 熔断

熔断机制。当服务之间发起调用的时候，如果被调用方返回的指定错误码的比例超过一定的阈值，那么后续的请求将不会真正发起，而是由调用方直接返回错误。

- 闭合状态下，请求失败，但是未达到失败阈值
- 请求失败，达到失败阈值，进入断开状态，此时，熔断，调用方直接返回错误
- 闭合状态下，会启动一个超时计时器，当计时器超时后，状态切换到半打开状态。在该状态下，允许应用程序将一定数量的请求发往被调用服务，如果这些调用正常，那么就可以认为被调用服务已经恢复正常，此时熔断器切换到闭合状态

![](https://gitee.com/wanglongxin666/pictures/raw/master/img/202402011012521.png)

### 熔断的粒度控制

服务、实例很不好，接口还可以

**实例的接口** 

### 错误类型

由于熔断机制是用来消除系统过载的，所以，我们需要识别出与系统过载相关的错误，来进行熔断处理，一般来说，主要有下面两个错误类型。

第一，系统被动对外表现出来的过载错误，一般来说，如果一个接口过载了，那么它的响应时间就会变长，熔断器捕获到的错误类型就是“响应超时”之类的超时错误。

第二，系统主动对外表现出来的过载错误，对于这种情况，一般是请求的流量触发了限流等机制返回的错误码，这个是我们在程序开发过程中主动设计的。

另外，我们要记住，熔断机制一定不要关心应用层的错误，比如余额不足之类的错误，因为这一类型的错误和系统的过载没有关系。

## 限流

### 限流规则

限流规则主要包括 算法、对象、阈值

限流对象主要包括：ip、接口、一个方法、一个系统资源等

限流算法 + 限流对象 + 限流阈值 组成服务端限流的核心规则

### 限流算法

#### 固定窗口和滑动窗口

固定窗口

2s限制100次

- 前10ms就达到100次
- 该周期最后10ms达到100次，下一个周期前10ms又达到100次

![](https://gitee.com/wanglongxin666/pictures/raw/master/img/202402011041212.png)

滑动窗口

解决相邻周期请求集中的问题：该周期最后10ms达到100次，下一个周期前10ms又达到100次

同样的，前10ms就达到100次，这个问题（抖动问题，突然拔高）依旧存在

![](https://gitee.com/wanglongxin666/pictures/raw/master/img/202402011044700.png)

#### 漏桶和令牌桶

**漏桶**

相对于滑动窗口和固定窗口来说，漏桶有两个改进点，第一，增加了一个桶来缓存请求，在流量突增的时候，可以先缓存起来，直到超过桶的容量才触发限流；第二，对出口的流量上限做了限制，使上游流量的抖动不会扩散到下游服务

漏桶提供流量整形能力有一定的代价，超过漏桶流出速率的请求，需要先在漏桶中排队等待，其中流出速率是漏桶限流的防线，一般会设置得相对保守，可是这样就无法完全利用系统的性能，就增加了请求的排队时间，说白了就是突发流量的处理变慢

固定速率处理请求

![](https://gitee.com/wanglongxin666/pictures/raw/master/img/202402011130465.png)

**令牌桶**

令牌桶以“恒定”的速率生产令牌，但是请求获取令牌的速率是“可变”的，可处理突发流量，但是也就会有抖动

![](https://gitee.com/wanglongxin666/pictures/raw/master/img/202402011131183.png)


**冷启动的令牌桶**

为解决的问题：令牌的生成是固定的，但令牌的发放是根据请求来的量决定的；如果请求量很大，会迅速消耗令牌，令牌的发放速度就迅速提升，冲击较大，需要动态调整令牌发放速度（控制发放的时间间隔）；

假如当前时间窗口内都没有Request过来，那么令牌桶中会装满100个令牌。如果在下一秒突然涌入100个请求，这些请求会迅速消耗令牌，对服务的瞬时冲击会比较大。

*Guava RateLimiter冷启动模型*

控制令牌发放速度

举例说明运作原理：

闲时到忙时的流量转变，闲的时候没几个流量，令牌桶基本是满的，在下一秒突然涌入10个请求，初始阶段，令牌的放行速度较慢(0.3s)，随着令牌逐渐被消耗，令牌容量只有Half容量（最低警戒线时），令牌发放速度以稳定(0.1s)的速率发放。

流量从忙时转变为闲时的过程中，令牌发放速率是由快到慢逐渐变化。起始阶段的令牌放行间隔是0.1s，随着令牌桶内令牌逐渐增多，达到最大容量时，放行令牌的时间间隔进一步增大为0.3s。

*Sentinel的冷启动模型*

区别于Guava的冷启动模型，其不控制每个请求的通过时间间隔（即令牌发放速度），而是控制每秒能通过的请求数（即控制令牌生产速度）。

| 算法                                | 优点                                                                                     | 缺点                             | 使用场景                             |
| ----------------------------------- | ---------------------------------------------------------------------------------------- | -------------------------------- | ------------------------------------ |
| 计数器                              | 实现简单                                                                                 | 临界突发流量问题                 |                                      |
| 滑动窗口                            | 小窗口滑动，流量曲线更加平滑                                                             | 没有根本解决临界突发流量问题     | 不是秒杀类的场景，常规的限流用这个OK |
| 漏桶                                | 均匀限流                                                                                 | 突发流量会有大量失败，用户体验差 | 流量整形场景                         |
| 令牌桶                              | 反向漏桶                                                                                 | 热点时，造成大量用户无法访问     | 电商抢购、热点事件等                 |
| Guava RateLimiter冷启动（预热）模型 | 控制令牌的发放速度（即控制请求通过的时间间隔）系统平稳，有度                             |                                  |                                      |
| Sentinel的冷启动模型                | 控制令牌的生产速度（即每秒能通过的请求量）动态调整令牌生产速度，灵活生产令牌的令牌桶思想 |                                  |                                      |


### 单节点限流

就是按照服务实例来，比如python装饰器在某些接口上

触发限流后：阻塞式限流还是否决式（直接抛弃请求）限流

### 分布式限流

集中限流，比如在 网关层

限流总阈值按照比例分配给服务实例

## 降级

虽然熔断机制可以确保系统不会雪崩，限流可以确保，被保护的服务不会因为过载而出现故障，可是这时候，系统的可用性或多或少都会受到一定的影响，并且这个影响不会区分核心业务和非核心业务。

那么你的脑海里一定会出现一个想法，是否可以在故障出现的时候，通过减少或停掉非核心业务，来降低系统的负载，让核心业务不会受到，或者少受到影响呢？其实是可以的，这就是一个典型的降级场景问题。

在当前极客时间的后端系统出现了过载问题的时候，或者我们预计到由于运营活动会出现突发流量的时候，我们有账号、支付和评论三个服务，停掉任意一个服务都可以让系统正常运行，那么相对于账号和支付这两个非常核心的服务，毫无疑问，我们会选择停掉评论服务来丢车保帅，降低系统故障对外的影响，这其实就是降级的核心思路。

首先，因为熔断机制是系统稳定性保障的最后一道防线，并且它是自适应的，所以我们应该在系统全局默认启用；其次，限流是用来保障被限流服务稳定性的，所以我们建议，一般在系统的核心链路和核心服务上，默认启用限流机制；最后，降级是通过牺牲被降级的接口或者服务，来保障其他的接口和服务正常运行的，所以我们可以通过降级直接停用非核心服务，然后对于核心接口和服务，在必要的时候，可以提供一个“ B 计划”。

